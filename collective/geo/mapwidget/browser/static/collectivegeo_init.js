/*global window, jQuery, document, OpenLayers, google*/


(function ($) {
    "use strict";

    // = Collective Geo init =
    //
    // This script initialize collective.geo maps for each .wiget-cgmap
    // collectivegeo.js for details
    //
    //
    // == Load maps ==
    //
    // After page has been loaded and the dom tree is fully instantiated
    // collective.geo javascript initalizes maps for each
    // {{{.widget-cgmap}}} div
    //
    // For each map you can customize some properties using data attributes
    //
    // * cgeolongitude
    // * cgeolatitude
    // * cgeozoom
    // * cgeolang
    //
    // you can also pass some default parameter to c.geo plugin:
    // For example.:
    //
    // {{{
    // maps.collectivegeo({
    //     center: new OpenLayers.LonLat('45.00', '7.3'),
    //     zoom: 7,
    //     lang: 'it'
    // });
    // }}}
    //
    //
    // == Add layers to specific map ==
    //
    // You can add layers to a map using {{{add_layer}}} method
    //
    // {{{
    // $('#mymap').collectivegeo(
    //     'add_layer',
    //     function () {
    //         return new OpenLayers.Layer...(
    //         ...layer code...
    //         );
    //     }
    // );
    // }}}
    //
    // or by {{{mapload}}} event
    //
    // {{{
    // $(window).bind('mapload', function (evt, widget) {
    //     widget.addLayers(
    //         [
    //             function () {
    //                 return new OpenLayers.Layer...(
    //                 ... layer code...
    //             }
    //         ],
    //         'mymapid'
    //     );
    // }}}

    $(window).bind("load", function () {
        var maps = $('.widget-cgmap'),
            map_widgets = $('.map-widget .widget-cgmap'),
            geosetting_map = $('#geosettings-cgmap'),
            fieldset = $(maps).parents('.formPanel'),
            tabs;

        maps.collectivegeo({
            // center: new OpenLayers.LonLat('45.00', '7.3'),
            // zoom: 7,
            // lang: 'it'
        });

        // === Map in hidden tabs ==
        //
        // When a map is displayed in a hidden tab or div
        // it has to be refreshed when the tab is show.
        //
        // This trick is working with jquerytools tabs in Plone forms
        // and also with tabs generated by {{{enableFormTabbing}}} class:
        // {{{
        //
        // <dl class="enableFormTabbing">
        //   ...
        //   <dt id="fieldsetlegend-map"><h2>My Map</h2></dt>
        //   <dd id="fieldset-map">
        //     <div id="mymap" class="widget-cgmap"></div>
        //   </dd>
        //   ...
        // </dl>
        //
        // }}}
        if (fieldset.length > 0) {
            tabs = $('select.formTabs, ul.formTabs');
            tabs.bind("onClick", function (e, index) {
                var curpanel = $(this).data('tabs').getCurrentPane();
                curpanel.find('.widget-cgmap').collectivegeo('refresh');
            });
        }

        // Set collective.geo control panel map with
        // marker edit layer and geocoder
        geosetting_map.collectivegeo(
            'add_markeredit_layer',
            'form-widgets-longitude',
            'form-widgets-latitude',
            'form-widgets-zoom'
        );
        geosetting_map.collectivegeo('add_geocoder');

        // Initialize all maps for collective.z3cform.mapwidget
        map_widgets.collectivegeo('add_edit_layer');
        map_widgets.collectivegeo('add_geocoder');
    });

}(jQuery));
